// =====================================================
// KJ KHANDALA BUS COMPANY - PRISMA SCHEMA
// Complete database schema with all company roles
// PostgreSQL Database
// =====================================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [uuid_ossp(map: "uuid-ossp")]
}

// =====================================================
// ENUMS
// =====================================================

enum AppRole {
  SUPER_ADMIN        @map("super_admin")
  ADMIN              @map("admin")
  OPERATIONS_MANAGER @map("operations_manager")
  MAINTENANCE_MANAGER @map("maintenance_manager")
  HR_MANAGER         @map("hr_manager")
  FINANCE_MANAGER    @map("finance_manager")
  TICKETING_OFFICER  @map("ticketing_officer")
  BOOKING_OFFICER    @map("booking_officer")
  DRIVER             @map("driver")
  PASSENGER          @map("passenger")

  @@map("app_role")
}

enum BookingStatus {
  PENDING   @map("pending")
  CONFIRMED @map("confirmed")
  CANCELLED @map("cancelled")

  @@map("booking_status")
}

enum RouteType {
  LOCAL        @map("local")
  CROSS_BORDER @map("cross_border")

  @@map("route_type")
}

enum SeatStatus {
  AVAILABLE @map("available")
  BOOKED    @map("booked")
  SELECTED  @map("selected")

  @@map("seat_status")
}

// =====================================================
// USER MANAGEMENT
// =====================================================

model User {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email         String    @unique
  password      String // Will be hashed
  emailVerified DateTime? @map("email_verified")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  profile     Profile?
  userRoles   UserRole[]
  bookings    Booking[]
  staff       Staff?
  auditLogs   AuditLog[]
  
  @@map("users")
}

model Profile {
  id         String    @id @db.Uuid
  fullName   String    @map("full_name")
  phone      String?
  email      String?
  idNumber   String?   @map("id_number")
  avatarUrl  String?   @map("avatar_url")
  department String?
  lastLogin  DateTime? @map("last_login")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [id], references: [id], onDelete: Cascade)

  @@map("profiles")
}

model UserRole {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String    @map("user_id") @db.Uuid
  role        AppRole
  department  String?
  permissions Json?
  isActive    Boolean   @default(true) @map("is_active")
  roleLevel   Int       @default(1) @map("role_level")
  assignedBy  String?   @map("assigned_by") @db.Uuid
  assignedAt  DateTime  @default(now()) @map("assigned_at")
  expiresAt   DateTime? @map("expires_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, role])
  @@index([userId])
  @@map("user_roles")
}

// =====================================================
// STAFF MANAGEMENT
// =====================================================

model Staff {
  id               String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId           String?   @unique @map("user_id") @db.Uuid
  fullName         String    @map("full_name")
  employeeId       String    @unique @map("employee_id")
  department       String
  position         String
  email            String?   @unique
  phone            String?
  hireDate         DateTime  @map("hire_date") @db.Date
  salary           Decimal?  @db.Decimal(10, 2)
  status           String    @default("active")
  dateOfBirth      DateTime? @map("date_of_birth") @db.Date
  address          String?
  emergencyContact String?   @map("emergency_contact")
  emergencyPhone   String?   @map("emergency_phone")
  bankAccount      String?   @map("bank_account")
  taxNumber        String?   @map("tax_number")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // Relations
  user              User?              @relation(fields: [userId], references: [id])
  attendance        StaffAttendance[]
  payroll           Payroll[]

  @@index([userId])
  @@index([employeeId])
  @@index([department])
  @@index([status])
  @@map("staff")
}

model StaffAttendance {
  id             String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  staffId        String    @map("staff_id") @db.Uuid
  attendanceDate DateTime  @map("attendance_date") @db.Date
  checkInTime    DateTime? @map("check_in_time")
  checkOutTime   DateTime? @map("check_out_time")
  status         String    @default("present")
  notes          String?
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  staff Staff @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@unique([staffId, attendanceDate])
  @@index([staffId])
  @@index([attendanceDate])
  @@map("staff_attendance")
}

model Payroll {
  id              String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  staffId         String    @map("staff_id") @db.Uuid
  payPeriodStart  DateTime  @map("pay_period_start") @db.Date
  payPeriodEnd    DateTime  @map("pay_period_end") @db.Date
  basicSalary     Decimal   @map("basic_salary") @db.Decimal(10, 2)
  allowances      Decimal   @default(0) @db.Decimal(10, 2)
  deductions      Decimal   @default(0) @db.Decimal(10, 2)
  overtime        Decimal   @default(0) @db.Decimal(10, 2)
  bonuses         Decimal   @default(0) @db.Decimal(10, 2)
  grossPay        Decimal   @map("gross_pay") @db.Decimal(10, 2)
  netPay          Decimal   @map("net_pay") @db.Decimal(10, 2)
  paymentDate     DateTime? @map("payment_date") @db.Date
  paymentMethod   String?   @map("payment_method")
  paymentRef      String?   @map("payment_reference")
  status          String    @default("pending")
  notes           String?
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  staff Staff @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@map("payroll")
}

// =====================================================
// FLEET MANAGEMENT
// =====================================================

model Bus {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name               String
  busNumber          String?   @map("bus_number")
  numberPlate        String    @unique @map("number_plate")
  registrationNumber String?   @map("registration_number")
  seatingCapacity    Int       @map("seating_capacity")
  layoutRows         Int       @default(10) @map("layout_rows")
  layoutColumns      Int       @default(4) @map("layout_columns")
  model              String?
  manufacturer       String?
  yearOfManufacture  Int?      @map("year_of_manufacture")
  status             String    @default("active")
  gpsDeviceId        String?   @map("gps_device_id")
  lastServiceDate    DateTime? @map("last_service_date") @db.Date
  nextServiceDate    DateTime? @map("next_service_date") @db.Date
  mileage            Int       @default(0)
  fuelType           String    @default("diesel") @map("fuel_type")
  insuranceExpiry    DateTime? @map("insurance_expiry") @db.Date
  licenseExpiry      DateTime? @map("license_expiry") @db.Date
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  // Relations
  schedules         Schedule[]
  maintenanceRecords MaintenanceRecord[]
  maintenanceReminders MaintenanceReminder[]
  gpsTracking       GpsTracking[]
  expenses          Expense[]

  @@index([busNumber])
  @@index([status])
  @@index([nextServiceDate])
  @@map("buses")
}

model MaintenanceRecord {
  id                String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  busId             String    @map("bus_id") @db.Uuid
  serviceType       String    @map("service_type")
  description       String
  serviceDate       DateTime  @map("service_date") @db.Date
  cost              Decimal?  @db.Decimal(10, 2)
  mileageAtService  Int?      @map("mileage_at_service")
  serviceProvider   String?   @map("service_provider")
  partsReplaced     String?   @map("parts_replaced")
  status            String    @default("pending")
  technicianName    String?   @map("technician_name")
  completionDate    DateTime? @map("completion_date") @db.Date
  nextServiceDate   DateTime? @map("next_service_date") @db.Date
  invoiceNumber     String?   @map("invoice_number")
  warrantyExpiry    DateTime? @map("warranty_expiry") @db.Date
  notes             String?
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  bus Bus @relation(fields: [busId], references: [id], onDelete: Cascade)

  @@index([busId])
  @@index([serviceDate])
  @@index([status])
  @@map("maintenance_records")
}

model MaintenanceReminder {
  id           String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  busId        String    @map("bus_id") @db.Uuid
  reminderType String    @map("reminder_type")
  dueDate      DateTime  @map("due_date") @db.Date
  description  String?
  status       String    @default("pending")
  priority     String    @default("medium")
  notifiedAt   DateTime? @map("notified_at")
  completedAt  DateTime? @map("completed_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  bus Bus @relation(fields: [busId], references: [id], onDelete: Cascade)

  @@map("maintenance_reminders")
}

// =====================================================
// DRIVER MANAGEMENT
// =====================================================

model Driver {
  id               String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  fullName         String    @map("full_name")
  licenseNumber    String    @unique @map("license_number")
  licenseExpiry    DateTime  @map("license_expiry") @db.Date
  phone            String?
  email            String?
  dateOfBirth      DateTime? @map("date_of_birth") @db.Date
  hireDate         DateTime? @map("hire_date") @db.Date
  status           String    @default("active")
  experienceYears  Int?      @map("experience_years")
  emergencyContact String?   @map("emergency_contact")
  emergencyPhone   String?   @map("emergency_phone")
  address          String?
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // Relations
  assignments DriverAssignment[]

  @@map("drivers")
}

model DriverAssignment {
  id         String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  scheduleId String    @map("schedule_id") @db.Uuid
  driverId   String    @map("driver_id") @db.Uuid
  assignedAt DateTime  @default(now()) @map("assigned_at")
  status     String    @default("assigned")
  notes      String?
  createdAt  DateTime  @default(now()) @map("created_at")

  // Relations
  schedule Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  driver   Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@unique([scheduleId, driverId])
  @@index([scheduleId])
  @@index([driverId])
  @@map("driver_assignments")
}

// =====================================================
// ROUTE AND SCHEDULE MANAGEMENT
// =====================================================

model Route {
  id                      String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  routeName               String?    @map("route_name")
  origin                  String
  destination             String
  price                   Decimal    @db.Decimal(10, 2)
  distanceKm              Decimal?   @map("distance_km") @db.Decimal(10, 2)
  durationHours           Decimal?   @map("duration_hours") @db.Decimal(5, 2)
  estimatedDurationMinutes Int?      @map("estimated_duration_minutes")
  routeType               RouteType  @default(LOCAL) @map("route_type")
  status                  String     @default("active")
  stops                   Json?
  active                  Boolean    @default(true)
  createdAt               DateTime   @default(now()) @map("created_at")
  updatedAt               DateTime   @updatedAt @map("updated_at")

  // Relations
  schedules      Schedule[]
  revenueSummary RevenueSummary[]

  @@index([status])
  @@index([origin, destination])
  @@map("routes")
}

model Schedule {
  id                  String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  routeId             String    @map("route_id") @db.Uuid
  busId               String    @map("bus_id") @db.Uuid
  departureDate       DateTime  @map("departure_date") @db.Date
  departureTime       DateTime  @map("departure_time") @db.Time
  arrivalTime         DateTime? @map("arrival_time") @db.Time
  availableSeats      Int       @map("available_seats")
  status              String    @default("scheduled")
  actualDepartureTime DateTime? @map("actual_departure_time")
  actualArrivalTime   DateTime? @map("actual_arrival_time")
  delayMinutes        Int       @default(0) @map("delay_minutes")
  cancellationReason  String?   @map("cancellation_reason")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // Relations
  route            Route              @relation(fields: [routeId], references: [id], onDelete: Cascade)
  bus              Bus                @relation(fields: [busId], references: [id], onDelete: Cascade)
  bookings         Booking[]
  driverAssignments DriverAssignment[]
  gpsTracking      GpsTracking[]

  @@index([routeId])
  @@index([busId])
  @@index([departureDate])
  @@index([status])
  @@index([routeId, departureDate])
  @@map("schedules")
}

// =====================================================
// BOOKING MANAGEMENT
// =====================================================

model BookingOffice {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name           String
  officeName     String?  @map("office_name")
  location       String
  phone          String?
  email          String?
  contactNumber  String   @map("contact_number")
  managerName    String?  @map("manager_name")
  operatingHours String   @map("operating_hours")
  openingHours   Json?    @map("opening_hours")
  status         String   @default("active")
  active         Boolean  @default(true)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@map("booking_offices")
}

model Booking {
  id                  String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  scheduleId          String        @map("schedule_id") @db.Uuid
  userId              String        @map("user_id") @db.Uuid
  passengerName       String        @map("passenger_name")
  passengerPhone      String        @map("passenger_phone")
  passengerEmail      String?       @map("passenger_email")
  passengerIdNumber   String?       @map("passenger_id_number")
  seatNumber          String        @map("seat_number")
  numberOfSeats       Int           @default(1) @map("number_of_seats")
  totalAmount         Decimal       @map("total_amount") @db.Decimal(10, 2)
  status              BookingStatus @default(PENDING)
  paymentStatus       String        @default("pending") @map("payment_status")
  paymentMethod       String?       @map("payment_method")
  paymentReference    String?       @map("payment_reference")
  bookingReference    String        @unique @map("booking_reference")
  bookingDate         DateTime      @default(now()) @map("booking_date")
  checkedInAt         DateTime?     @map("checked_in_at")
  specialRequirements String?       @map("special_requirements")
  createdAt           DateTime      @default(now()) @map("created_at")
  updatedAt           DateTime      @updatedAt @map("updated_at")

  // Relations
  schedule Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([scheduleId])
  @@index([userId])
  @@index([bookingDate])
  @@index([status])
  @@index([paymentStatus])
  @@index([checkedInAt])
  @@map("bookings")
}

// =====================================================
// FINANCIAL MANAGEMENT
// =====================================================

model Expense {
  id             String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  expenseType    String    @map("expense_type")
  amount         Decimal   @db.Decimal(10, 2)
  expenseDate    DateTime  @map("expense_date") @db.Date
  description    String?
  category       String?
  vendor         String?
  invoiceNumber  String?   @map("invoice_number")
  paymentMethod  String?   @map("payment_method")
  approvedBy     String?   @map("approved_by")
  status         String    @default("pending")
  busId          String?   @map("bus_id") @db.Uuid
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  bus Bus? @relation(fields: [busId], references: [id])

  @@index([expenseDate])
  @@index([expenseType])
  @@map("expenses")
}

model RevenueSummary {
  id                  String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  date                DateTime @db.Date
  routeId             String?  @map("route_id") @db.Uuid
  totalBookings       Int      @default(0) @map("total_bookings")
  totalRevenue        Decimal  @default(0) @map("total_revenue") @db.Decimal(10, 2)
  cashRevenue         Decimal  @default(0) @map("cash_revenue") @db.Decimal(10, 2)
  cardRevenue         Decimal  @default(0) @map("card_revenue") @db.Decimal(10, 2)
  mobileMoneyRevenue  Decimal  @default(0) @map("mobile_money_revenue") @db.Decimal(10, 2)
  refunds             Decimal  @default(0) @db.Decimal(10, 2)
  netRevenue          Decimal  @default(0) @map("net_revenue") @db.Decimal(10, 2)
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Relations
  route Route? @relation(fields: [routeId], references: [id])

  @@unique([date, routeId])
  @@index([date])
  @@index([routeId])
  @@map("revenue_summary")
}

// =====================================================
// GPS AND TRACKING
// =====================================================

model GpsTracking {
  id           String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  busId        String?  @map("bus_id") @db.Uuid
  scheduleId   String?  @map("schedule_id") @db.Uuid
  latitude     Decimal  @db.Decimal(10, 8)
  longitude    Decimal  @db.Decimal(11, 8)
  speed        Decimal? @db.Decimal(10, 2)
  heading      Decimal? @db.Decimal(5, 2)
  altitude     Decimal? @db.Decimal(10, 2)
  accuracy     Decimal? @db.Decimal(10, 2)
  timestamp    DateTime @default(now())
  status       String   @default("active")
  fuelLevel    Decimal? @map("fuel_level") @db.Decimal(5, 2)
  engineStatus String?  @map("engine_status")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  bus      Bus?      @relation(fields: [busId], references: [id])
  schedule Schedule? @relation(fields: [scheduleId], references: [id])

  @@index([busId, timestamp])
  @@index([scheduleId])
  @@map("gps_tracking")
}

// =====================================================
// NOTIFICATIONS AND AUDIT
// =====================================================

model Notification {
  id                String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  title             String
  message           String
  type              String
  priority          String    @default("medium")
  targetUserId      String?   @map("target_user_id") @db.Uuid
  targetRole        String?   @map("target_role")
  status            String    @default("unread")
  relatedEntityType String?   @map("related_entity_type")
  relatedEntityId   String?   @map("related_entity_id") @db.Uuid
  actionUrl         String?   @map("action_url")
  readAt            DateTime? @map("read_at")
  createdAt         DateTime  @default(now()) @map("created_at")

  @@index([createdAt])
  @@index([targetUserId, status])
  @@map("notifications")
}

model AuditLog {
  id         String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tableName  String   @map("table_name")
  recordId   String   @map("record_id") @db.Uuid
  action     String
  oldValues  Json?    @map("old_values")
  newValues  Json?    @map("new_values")
  userId     String?  @map("user_id") @db.Uuid
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id])

  @@index([tableName])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}
